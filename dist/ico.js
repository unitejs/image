"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * ICO class for manipulating ICO images.
 */
const Jimp = require("jimp");
const parameterValidation_1 = require("unitejs-framework/dist/helpers/parameterValidation");
const defaultLogger_1 = require("unitejs-framework/dist/loggers/defaultLogger");
class ICO {
    fromPngs(logger, fileSystem, sourceFolder, sourceFiles, destFolder, destFile) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                if (logger === undefined || logger === null) {
                    defaultLogger_1.DefaultLogger.log("Unable to continue without logger");
                    return 1;
                }
                if (fileSystem === undefined || fileSystem === null) {
                    logger.error("Unable to continue without file system");
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "sourceFolder", sourceFolder)) {
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "sourceFiles", sourceFiles)) {
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "destFolder", destFolder)) {
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "destFile", destFile)) {
                    return 1;
                }
                const imageData = [];
                for (let i = 0; i < sourceFiles.length; i++) {
                    const fileExists = yield fileSystem.fileExists(sourceFolder, sourceFiles[i]);
                    if (fileExists) {
                        const pngBuffer = yield fileSystem.fileReadBinary(sourceFolder, sourceFiles[i]);
                        if (pngBuffer.length > 0) {
                            const j = yield Jimp.read(new Buffer(pngBuffer));
                            imageData.push(j);
                        }
                        else {
                            logger.error("Source Image is zero length", undefined, [sourceFiles[i]]);
                            return 1;
                        }
                    }
                    else {
                        logger.error("Source Image does not exist", undefined, [sourceFiles[i]]);
                        return 1;
                    }
                }
                const dirExists = yield fileSystem.directoryExists(destFolder);
                if (!dirExists) {
                    yield fileSystem.directoryCreate(destFolder);
                }
                const icoData = this.imagesToIco(imageData);
                yield fileSystem.fileWriteBinary(destFolder, destFile, icoData);
                return 0;
            }
            catch (e) {
                logger.error("Conversion failed", e);
                return 1;
            }
        });
    }
    imagesToIco(images) {
        const header = this.getHeader(images.length);
        const headerAndIconDir = [header];
        const imageDataArr = [];
        let len = header.length;
        let offset = header.length + (images.length * 16);
        images.forEach(img => {
            const dir = this.getDir(img, offset);
            const bmpInfoHeader = this.getBmpInfoHeader(img);
            const dib = this.getDib(img);
            headerAndIconDir.push(dir);
            imageDataArr.push(bmpInfoHeader, dib);
            len += dir.length + bmpInfoHeader.length + dib.length;
            offset += bmpInfoHeader.length + dib.length;
        });
        return Buffer.concat(headerAndIconDir.concat(imageDataArr), len);
    }
    // https://en.wikipedia.org/wiki/ICO_(file_format)
    getHeader(numOfImages) {
        const buf = Buffer.alloc(6);
        buf.writeUInt16LE(0, 0); // Reserved. Must always be 0.
        buf.writeUInt16LE(1, 2); // Specifies image type: 1 for icon (.ICO) image
        buf.writeUInt16LE(numOfImages, 4); // Specifies number of images in the file.
        return buf;
    }
    getDir(img, offset) {
        const buf = Buffer.alloc(16);
        const bitmap = img.bitmap;
        const size = bitmap.data.length + 40;
        const width = bitmap.width >= 256 ? 0 : bitmap.width;
        const height = width;
        const bpp = 32;
        buf.writeUInt8(width, 0); // Specifies image width in pixels.
        buf.writeUInt8(height, 1); // Specifies image height in pixels.
        buf.writeUInt8(0, 2); // Should be 0 if the image does not use a color palette.
        buf.writeUInt8(0, 3); // Reserved. Should be 0.
        buf.writeUInt16LE(0, 4); // Specifies color planes. Should be 0 or 1.
        buf.writeUInt16LE(bpp, 6); // Specifies bits per pixel.
        buf.writeUInt32LE(size, 8); // Specifies the size of the image's data in bytes
        buf.writeUInt32LE(offset, 12); // Specifies the offset of BMP or PNG data from the beginning of the ICO/CUR file
        return buf;
    }
    // https://en.wikipedia.org/wiki/BMP_file_format
    getBmpInfoHeader(img) {
        const buf = Buffer.alloc(40);
        const bitmap = img.bitmap;
        const size = bitmap.data.length;
        const width = bitmap.width;
        // https://en.wikipedia.org/wiki/ICO_(file_format)
        // ...Even if the AND mask is not supplied,
        // if the image is in Windows BMP format,
        // the BMP header must still specify a doubled height.
        const height = width * 2;
        const bpp = 32;
        buf.writeUInt32LE(40, 0); // The size of this header (40 bytes)
        buf.writeInt32LE(width, 4); // The bitmap width in pixels (signed integer)
        buf.writeInt32LE(height, 8); // The bitmap height in pixels (signed integer)
        buf.writeUInt16LE(1, 12); // The number of color planes (must be 1)
        buf.writeUInt16LE(bpp, 14); // The number of bits per pixel
        buf.writeUInt32LE(0, 16); // The compression method being used.
        buf.writeUInt32LE(size, 20); // The image size.
        buf.writeInt32LE(0, 24); // The horizontal resolution of the image. (signed integer)
        buf.writeInt32LE(0, 28); // The horizontal resolution of the image. (signed integer)
        buf.writeUInt32LE(0, 32); // The number of colors in the color palette, or 0 to default to 2n
        buf.writeUInt32LE(0, 36); // 	The number of important colors used, or 0 when every color is important; generally ignored.
        return buf;
    }
    // https://en.wikipedia.org/wiki/BMP_file_format
    // Note that the bitmap data starts with the lower left hand corner of the image.
    // blue green red alpha in order
    getDib(img) {
        const bitmap = img.bitmap;
        const size = bitmap.data.length;
        const buf = Buffer.alloc(size);
        const width = bitmap.width;
        const height = width;
        const lowerLeftPos = (height - 1) * width * 4;
        for (let x = 0; x < width; x++) {
            for (let y = 0; y < height; y++) {
                const pxColor = img.getPixelColor(x, y);
                const r = pxColor >> 24 & 255;
                const g = pxColor >> 16 & 255;
                const b = pxColor >> 8 & 255;
                const a = pxColor & 255;
                const bmpPos = lowerLeftPos - y * width * 4 + x * 4;
                buf.writeUInt8(b, bmpPos);
                buf.writeUInt8(g, bmpPos + 1);
                buf.writeUInt8(r, bmpPos + 2);
                buf.writeUInt8(a, bmpPos + 3);
            }
        }
        return buf;
    }
}
exports.ICO = ICO;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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KipcbiAqIElDTyBjbGFzcyBmb3IgbWFuaXB1bGF0aW5nIElDTyBpbWFnZXMuXG4gKi9cbmltcG9ydCAqIGFzIEppbXAgZnJvbSBcImppbXBcIjtcbmltcG9ydCB7IFBhcmFtZXRlclZhbGlkYXRpb24gfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9oZWxwZXJzL3BhcmFtZXRlclZhbGlkYXRpb25cIjtcbmltcG9ydCB7IElGaWxlU3lzdGVtIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvaW50ZXJmYWNlcy9JRmlsZVN5c3RlbVwiO1xuaW1wb3J0IHsgSUxvZ2dlciB9IGZyb20gXCJ1bml0ZWpzLWZyYW1ld29yay9kaXN0L2ludGVyZmFjZXMvSUxvZ2dlclwiO1xuaW1wb3J0IHsgRGVmYXVsdExvZ2dlciB9IGZyb20gXCJ1bml0ZWpzLWZyYW1ld29yay9kaXN0L2xvZ2dlcnMvZGVmYXVsdExvZ2dlclwiO1xuXG5leHBvcnQgY2xhc3MgSUNPIHtcbiAgICBwdWJsaWMgYXN5bmMgZnJvbVBuZ3MobG9nZ2VyOiBJTG9nZ2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlU3lzdGVtOiBJRmlsZVN5c3RlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlRm9sZGVyOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VGaWxlczogc3RyaW5nW10gfCB1bmRlZmluZWQgfCBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0Rm9sZGVyOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0RmlsZTogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCk6IFByb21pc2U8bnVtYmVyPiB7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChsb2dnZXIgPT09IHVuZGVmaW5lZCB8fCBsb2dnZXIgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBEZWZhdWx0TG9nZ2VyLmxvZyhcIlVuYWJsZSB0byBjb250aW51ZSB3aXRob3V0IGxvZ2dlclwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGZpbGVTeXN0ZW0gPT09IHVuZGVmaW5lZCB8fCBmaWxlU3lzdGVtID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiVW5hYmxlIHRvIGNvbnRpbnVlIHdpdGhvdXQgZmlsZSBzeXN0ZW1cIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghUGFyYW1ldGVyVmFsaWRhdGlvbi5ub3RFbXB0eShsb2dnZXIsIFwic291cmNlRm9sZGVyXCIsIHNvdXJjZUZvbGRlcikpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFQYXJhbWV0ZXJWYWxpZGF0aW9uLm5vdEVtcHR5KGxvZ2dlciwgXCJzb3VyY2VGaWxlc1wiLCBzb3VyY2VGaWxlcykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFQYXJhbWV0ZXJWYWxpZGF0aW9uLm5vdEVtcHR5KGxvZ2dlciwgXCJkZXN0Rm9sZGVyXCIsIGRlc3RGb2xkZXIpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghUGFyYW1ldGVyVmFsaWRhdGlvbi5ub3RFbXB0eShsb2dnZXIsIFwiZGVzdEZpbGVcIiwgZGVzdEZpbGUpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGltYWdlRGF0YTogSmltcFtdID0gW107XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNvdXJjZUZpbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZUV4aXN0cyA9IGF3YWl0IGZpbGVTeXN0ZW0uZmlsZUV4aXN0cyhzb3VyY2VGb2xkZXIsIHNvdXJjZUZpbGVzW2ldKTtcbiAgICAgICAgICAgICAgICBpZiAoZmlsZUV4aXN0cykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwbmdCdWZmZXIgPSBhd2FpdCBmaWxlU3lzdGVtLmZpbGVSZWFkQmluYXJ5KHNvdXJjZUZvbGRlciwgc291cmNlRmlsZXNbaV0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAocG5nQnVmZmVyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGogPSBhd2FpdCBKaW1wLnJlYWQobmV3IEJ1ZmZlcihwbmdCdWZmZXIpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlRGF0YS5wdXNoKGopO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiU291cmNlIEltYWdlIGlzIHplcm8gbGVuZ3RoXCIsIHVuZGVmaW5lZCwgWyBzb3VyY2VGaWxlc1tpXSBdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiU291cmNlIEltYWdlIGRvZXMgbm90IGV4aXN0XCIsIHVuZGVmaW5lZCwgWyBzb3VyY2VGaWxlc1tpXSBdKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBkaXJFeGlzdHMgPSBhd2FpdCBmaWxlU3lzdGVtLmRpcmVjdG9yeUV4aXN0cyhkZXN0Rm9sZGVyKTtcbiAgICAgICAgICAgIGlmICghZGlyRXhpc3RzKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZmlsZVN5c3RlbS5kaXJlY3RvcnlDcmVhdGUoZGVzdEZvbGRlcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGljb0RhdGEgPSB0aGlzLmltYWdlc1RvSWNvKGltYWdlRGF0YSk7XG5cbiAgICAgICAgICAgIGF3YWl0IGZpbGVTeXN0ZW0uZmlsZVdyaXRlQmluYXJ5KGRlc3RGb2xkZXIsIGRlc3RGaWxlLCBpY29EYXRhKTtcblxuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkNvbnZlcnNpb24gZmFpbGVkXCIsIGUpO1xuICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGltYWdlc1RvSWNvKGltYWdlczogSmltcFtdKTogQnVmZmVyIHtcbiAgICAgICAgY29uc3QgaGVhZGVyID0gdGhpcy5nZXRIZWFkZXIoaW1hZ2VzLmxlbmd0aCk7XG4gICAgICAgIGNvbnN0IGhlYWRlckFuZEljb25EaXIgPSBbaGVhZGVyXTtcbiAgICAgICAgY29uc3QgaW1hZ2VEYXRhQXJyOiBCdWZmZXJbXSA9IFtdO1xuXG4gICAgICAgIGxldCBsZW4gPSBoZWFkZXIubGVuZ3RoO1xuICAgICAgICBsZXQgb2Zmc2V0ID0gaGVhZGVyLmxlbmd0aCArIChpbWFnZXMubGVuZ3RoICogMTYpO1xuXG4gICAgICAgIGltYWdlcy5mb3JFYWNoKGltZyA9PiB7XG4gICAgICAgICAgICBjb25zdCBkaXIgPSB0aGlzLmdldERpcihpbWcsIG9mZnNldCk7XG4gICAgICAgICAgICBjb25zdCBibXBJbmZvSGVhZGVyID0gdGhpcy5nZXRCbXBJbmZvSGVhZGVyKGltZyk7XG4gICAgICAgICAgICBjb25zdCBkaWIgPSB0aGlzLmdldERpYihpbWcpO1xuXG4gICAgICAgICAgICBoZWFkZXJBbmRJY29uRGlyLnB1c2goZGlyKTtcbiAgICAgICAgICAgIGltYWdlRGF0YUFyci5wdXNoKGJtcEluZm9IZWFkZXIsIGRpYik7XG5cbiAgICAgICAgICAgIGxlbiArPSBkaXIubGVuZ3RoICsgYm1wSW5mb0hlYWRlci5sZW5ndGggKyBkaWIubGVuZ3RoO1xuICAgICAgICAgICAgb2Zmc2V0ICs9IGJtcEluZm9IZWFkZXIubGVuZ3RoICsgZGliLmxlbmd0aDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5jb25jYXQoaGVhZGVyQW5kSWNvbkRpci5jb25jYXQoaW1hZ2VEYXRhQXJyKSwgbGVuKTtcbiAgICB9XG5cbiAgICAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9JQ09fKGZpbGVfZm9ybWF0KVxuICAgIHByaXZhdGUgZ2V0SGVhZGVyKG51bU9mSW1hZ2VzOiBudW1iZXIpOiBCdWZmZXIge1xuICAgICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2MoNik7XG5cbiAgICAgICAgYnVmLndyaXRlVUludDE2TEUoMCwgMCk7IC8vIFJlc2VydmVkLiBNdXN0IGFsd2F5cyBiZSAwLlxuICAgICAgICBidWYud3JpdGVVSW50MTZMRSgxLCAyKTsgLy8gU3BlY2lmaWVzIGltYWdlIHR5cGU6IDEgZm9yIGljb24gKC5JQ08pIGltYWdlXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQxNkxFKG51bU9mSW1hZ2VzLCA0KTsgLy8gU3BlY2lmaWVzIG51bWJlciBvZiBpbWFnZXMgaW4gdGhlIGZpbGUuXG5cbiAgICAgICAgcmV0dXJuIGJ1ZjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldERpcihpbWc6IEppbXAsIG9mZnNldDogbnVtYmVyKTogQnVmZmVyIHtcbiAgICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmFsbG9jKDE2KTtcbiAgICAgICAgY29uc3QgYml0bWFwID0gaW1nLmJpdG1hcDtcbiAgICAgICAgY29uc3Qgc2l6ZSA9IGJpdG1hcC5kYXRhLmxlbmd0aCArIDQwO1xuICAgICAgICBjb25zdCB3aWR0aCA9IGJpdG1hcC53aWR0aCA+PSAyNTYgPyAwIDogYml0bWFwLndpZHRoO1xuICAgICAgICBjb25zdCBoZWlnaHQgPSB3aWR0aDtcbiAgICAgICAgY29uc3QgYnBwID0gMzI7XG5cbiAgICAgICAgYnVmLndyaXRlVUludDgod2lkdGgsIDApOyAvLyBTcGVjaWZpZXMgaW1hZ2Ugd2lkdGggaW4gcGl4ZWxzLlxuICAgICAgICBidWYud3JpdGVVSW50OChoZWlnaHQsIDEpOyAvLyBTcGVjaWZpZXMgaW1hZ2UgaGVpZ2h0IGluIHBpeGVscy5cbiAgICAgICAgYnVmLndyaXRlVUludDgoMCwgMik7IC8vIFNob3VsZCBiZSAwIGlmIHRoZSBpbWFnZSBkb2VzIG5vdCB1c2UgYSBjb2xvciBwYWxldHRlLlxuICAgICAgICBidWYud3JpdGVVSW50OCgwLCAzKTsgLy8gUmVzZXJ2ZWQuIFNob3VsZCBiZSAwLlxuICAgICAgICBidWYud3JpdGVVSW50MTZMRSgwLCA0KTsgLy8gU3BlY2lmaWVzIGNvbG9yIHBsYW5lcy4gU2hvdWxkIGJlIDAgb3IgMS5cbiAgICAgICAgYnVmLndyaXRlVUludDE2TEUoYnBwLCA2KTsgLy8gU3BlY2lmaWVzIGJpdHMgcGVyIHBpeGVsLlxuICAgICAgICBidWYud3JpdGVVSW50MzJMRShzaXplLCA4KTsgLy8gU3BlY2lmaWVzIHRoZSBzaXplIG9mIHRoZSBpbWFnZSdzIGRhdGEgaW4gYnl0ZXNcbiAgICAgICAgYnVmLndyaXRlVUludDMyTEUob2Zmc2V0LCAxMik7IC8vIFNwZWNpZmllcyB0aGUgb2Zmc2V0IG9mIEJNUCBvciBQTkcgZGF0YSBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIElDTy9DVVIgZmlsZVxuXG4gICAgICAgIHJldHVybiBidWY7XG4gICAgfVxuXG4gICAgLy8gaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQk1QX2ZpbGVfZm9ybWF0XG4gICAgcHJpdmF0ZSBnZXRCbXBJbmZvSGVhZGVyKGltZzogSmltcCk6IEJ1ZmZlciB7XG4gICAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5hbGxvYyg0MCk7XG4gICAgICAgIGNvbnN0IGJpdG1hcCA9IGltZy5iaXRtYXA7XG4gICAgICAgIGNvbnN0IHNpemUgPSBiaXRtYXAuZGF0YS5sZW5ndGg7XG4gICAgICAgIGNvbnN0IHdpZHRoID0gYml0bWFwLndpZHRoO1xuICAgICAgICAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9JQ09fKGZpbGVfZm9ybWF0KVxuICAgICAgICAvLyAuLi5FdmVuIGlmIHRoZSBBTkQgbWFzayBpcyBub3Qgc3VwcGxpZWQsXG4gICAgICAgIC8vIGlmIHRoZSBpbWFnZSBpcyBpbiBXaW5kb3dzIEJNUCBmb3JtYXQsXG4gICAgICAgIC8vIHRoZSBCTVAgaGVhZGVyIG11c3Qgc3RpbGwgc3BlY2lmeSBhIGRvdWJsZWQgaGVpZ2h0LlxuICAgICAgICBjb25zdCBoZWlnaHQgPSB3aWR0aCAqIDI7XG4gICAgICAgIGNvbnN0IGJwcCA9IDMyO1xuXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQzMkxFKDQwLCAwKTsgLy8gVGhlIHNpemUgb2YgdGhpcyBoZWFkZXIgKDQwIGJ5dGVzKVxuICAgICAgICBidWYud3JpdGVJbnQzMkxFKHdpZHRoLCA0KTsgLy8gVGhlIGJpdG1hcCB3aWR0aCBpbiBwaXhlbHMgKHNpZ25lZCBpbnRlZ2VyKVxuICAgICAgICBidWYud3JpdGVJbnQzMkxFKGhlaWdodCwgOCk7IC8vIFRoZSBiaXRtYXAgaGVpZ2h0IGluIHBpeGVscyAoc2lnbmVkIGludGVnZXIpXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQxNkxFKDEsIDEyKTsgLy8gVGhlIG51bWJlciBvZiBjb2xvciBwbGFuZXMgKG11c3QgYmUgMSlcbiAgICAgICAgYnVmLndyaXRlVUludDE2TEUoYnBwLCAxNCk7IC8vIFRoZSBudW1iZXIgb2YgYml0cyBwZXIgcGl4ZWxcbiAgICAgICAgYnVmLndyaXRlVUludDMyTEUoMCwgMTYpOyAvLyBUaGUgY29tcHJlc3Npb24gbWV0aG9kIGJlaW5nIHVzZWQuXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQzMkxFKHNpemUsIDIwKTsgLy8gVGhlIGltYWdlIHNpemUuXG4gICAgICAgIGJ1Zi53cml0ZUludDMyTEUoMCwgMjQpOyAvLyBUaGUgaG9yaXpvbnRhbCByZXNvbHV0aW9uIG9mIHRoZSBpbWFnZS4gKHNpZ25lZCBpbnRlZ2VyKVxuICAgICAgICBidWYud3JpdGVJbnQzMkxFKDAsIDI4KTsgLy8gVGhlIGhvcml6b250YWwgcmVzb2x1dGlvbiBvZiB0aGUgaW1hZ2UuIChzaWduZWQgaW50ZWdlcilcbiAgICAgICAgYnVmLndyaXRlVUludDMyTEUoMCwgMzIpOyAvLyBUaGUgbnVtYmVyIG9mIGNvbG9ycyBpbiB0aGUgY29sb3IgcGFsZXR0ZSwgb3IgMCB0byBkZWZhdWx0IHRvIDJuXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQzMkxFKDAsIDM2KTsgLy8gXHRUaGUgbnVtYmVyIG9mIGltcG9ydGFudCBjb2xvcnMgdXNlZCwgb3IgMCB3aGVuIGV2ZXJ5IGNvbG9yIGlzIGltcG9ydGFudDsgZ2VuZXJhbGx5IGlnbm9yZWQuXG5cbiAgICAgICAgcmV0dXJuIGJ1ZjtcbiAgICB9XG5cbiAgICAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9CTVBfZmlsZV9mb3JtYXRcbiAgICAvLyBOb3RlIHRoYXQgdGhlIGJpdG1hcCBkYXRhIHN0YXJ0cyB3aXRoIHRoZSBsb3dlciBsZWZ0IGhhbmQgY29ybmVyIG9mIHRoZSBpbWFnZS5cbiAgICAvLyBibHVlIGdyZWVuIHJlZCBhbHBoYSBpbiBvcmRlclxuICAgIHByaXZhdGUgZ2V0RGliKGltZzogSmltcCk6IEJ1ZmZlciB7XG4gICAgICAgIGNvbnN0IGJpdG1hcCA9IGltZy5iaXRtYXA7XG4gICAgICAgIGNvbnN0IHNpemUgPSBiaXRtYXAuZGF0YS5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5hbGxvYyhzaXplKTtcbiAgICAgICAgY29uc3Qgd2lkdGggPSBiaXRtYXAud2lkdGg7XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHdpZHRoO1xuICAgICAgICBjb25zdCBsb3dlckxlZnRQb3MgPSAoaGVpZ2h0IC0gMSkgKiB3aWR0aCAqIDQ7XG5cbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB3aWR0aDsgeCsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IGhlaWdodDsgeSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcHhDb2xvciA9IGltZy5nZXRQaXhlbENvbG9yKHgsIHkpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgciA9IHB4Q29sb3IgPj4gMjQgJiAyNTU7XG4gICAgICAgICAgICAgICAgY29uc3QgZyA9IHB4Q29sb3IgPj4gMTYgJiAyNTU7XG4gICAgICAgICAgICAgICAgY29uc3QgYiA9IHB4Q29sb3IgPj4gOCAmIDI1NTtcbiAgICAgICAgICAgICAgICBjb25zdCBhID0gcHhDb2xvciAmIDI1NTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGJtcFBvcyA9IGxvd2VyTGVmdFBvcyAtIHkgKiB3aWR0aCAqIDQgKyB4ICogNDtcblxuICAgICAgICAgICAgICAgIGJ1Zi53cml0ZVVJbnQ4KGIsIGJtcFBvcyk7XG4gICAgICAgICAgICAgICAgYnVmLndyaXRlVUludDgoZywgYm1wUG9zICsgMSk7XG4gICAgICAgICAgICAgICAgYnVmLndyaXRlVUludDgociwgYm1wUG9zICsgMik7XG4gICAgICAgICAgICAgICAgYnVmLndyaXRlVUludDgoYSwgYm1wUG9zICsgMyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYnVmO1xuICAgIH1cbn1cbiJdfQ==
