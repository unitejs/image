"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * ICO class for manipulating ICO images.
 */
const Jimp = require("jimp");
const parameterValidation_1 = require("unitejs-framework/dist/helpers/parameterValidation");
const defaultLogger_1 = require("unitejs-framework/dist/loggers/defaultLogger");
class ICO {
    fromPngs(logger, fileSystem, sourceFolder, sourceFiles, destFolder, destFile) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                if (logger === undefined || logger === null) {
                    defaultLogger_1.DefaultLogger.log("Unable to continue without logger");
                    return 1;
                }
                if (fileSystem === undefined || fileSystem === null) {
                    logger.error("Unable to continue without file system");
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "sourceFolder", sourceFolder)) {
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "sourceFiles", sourceFiles)) {
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "destFolder", destFolder)) {
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "destFile", destFile)) {
                    return 1;
                }
                const imageData = [];
                for (let i = 0; i < sourceFiles.length; i++) {
                    const fileExists = yield fileSystem.fileExists(sourceFolder, sourceFiles[i]);
                    if (fileExists) {
                        const pngBuffer = yield fileSystem.fileReadBinary(sourceFolder, sourceFiles[i]);
                        if (pngBuffer.length > 0) {
                            const j = yield Jimp.read(new Buffer(pngBuffer));
                            imageData.push(j);
                        }
                        else {
                            logger.error("Source Image is zero length", undefined, [sourceFiles[i]]);
                            return 1;
                        }
                    }
                    else {
                        logger.error("Source Image does not exist", undefined, [sourceFiles[i]]);
                        return 1;
                    }
                }
                const dirExists = yield fileSystem.directoryExists(destFolder);
                if (!dirExists) {
                    yield fileSystem.directoryCreate(destFolder);
                }
                const icoData = this.imagesToIco(imageData);
                yield fileSystem.fileWriteBinary(destFolder, destFile, icoData);
                return 0;
            }
            catch (e) {
                logger.error("Conversion failed", e);
                return 1;
            }
        });
    }
    imagesToIco(images) {
        const header = this.getHeader(images.length);
        const headerAndIconDir = [header];
        const imageDataArr = [];
        let len = header.length;
        let offset = header.length + (images.length * 16);
        images.forEach(img => {
            const dir = this.getDir(img, offset);
            const bmpInfoHeader = this.getBmpInfoHeader(img);
            const dib = this.getDib(img);
            headerAndIconDir.push(dir);
            imageDataArr.push(bmpInfoHeader, dib);
            len += dir.length + bmpInfoHeader.length + dib.length;
            offset += bmpInfoHeader.length + dib.length;
        });
        return Buffer.concat(headerAndIconDir.concat(imageDataArr), len);
    }
    // https://en.wikipedia.org/wiki/ICO_(file_format)
    getHeader(numOfImages) {
        const buf = Buffer.alloc(6);
        buf.writeUInt16LE(0, 0); // Reserved. Must always be 0.
        buf.writeUInt16LE(1, 2); // Specifies image type: 1 for icon (.ICO) image
        buf.writeUInt16LE(numOfImages, 4); // Specifies number of images in the file.
        return buf;
    }
    getDir(img, offset) {
        const buf = Buffer.alloc(16);
        const bitmap = img.bitmap;
        const size = bitmap.data.length + 40;
        const width = bitmap.width >= 256 ? 0 : bitmap.width;
        const height = width;
        const bpp = 32;
        buf.writeUInt8(width, 0); // Specifies image width in pixels.
        buf.writeUInt8(height, 1); // Specifies image height in pixels.
        buf.writeUInt8(0, 2); // Should be 0 if the image does not use a color palette.
        buf.writeUInt8(0, 3); // Reserved. Should be 0.
        buf.writeUInt16LE(0, 4); // Specifies color planes. Should be 0 or 1.
        buf.writeUInt16LE(bpp, 6); // Specifies bits per pixel.
        buf.writeUInt32LE(size, 8); // Specifies the size of the image's data in bytes
        buf.writeUInt32LE(offset, 12); // Specifies the offset of BMP or PNG data from the beginning of the ICO/CUR file
        return buf;
    }
    // https://en.wikipedia.org/wiki/BMP_file_format
    getBmpInfoHeader(img) {
        const buf = Buffer.alloc(40);
        const bitmap = img.bitmap;
        const size = bitmap.data.length;
        const width = bitmap.width;
        // https://en.wikipedia.org/wiki/ICO_(file_format)
        // ...Even if the AND mask is not supplied,
        // if the image is in Windows BMP format,
        // the BMP header must still specify a doubled height.
        const height = width * 2;
        const bpp = 32;
        buf.writeUInt32LE(40, 0); // The size of this header (40 bytes)
        buf.writeInt32LE(width, 4); // The bitmap width in pixels (signed integer)
        buf.writeInt32LE(height, 8); // The bitmap height in pixels (signed integer)
        buf.writeUInt16LE(1, 12); // The number of color planes (must be 1)
        buf.writeUInt16LE(bpp, 14); // The number of bits per pixel
        buf.writeUInt32LE(0, 16); // The compression method being used.
        buf.writeUInt32LE(size, 20); // The image size.
        buf.writeInt32LE(0, 24); // The horizontal resolution of the image. (signed integer)
        buf.writeInt32LE(0, 28); // The horizontal resolution of the image. (signed integer)
        buf.writeUInt32LE(0, 32); // The number of colors in the color palette, or 0 to default to 2n
        buf.writeUInt32LE(0, 36); // 	The number of important colors used, or 0 when every color is important; generally ignored.
        return buf;
    }
    // https://en.wikipedia.org/wiki/BMP_file_format
    // Note that the bitmap data starts with the lower left hand corner of the image.
    // blue green red alpha in order
    getDib(img) {
        const bitmap = img.bitmap;
        const size = bitmap.data.length;
        const buf = Buffer.alloc(size);
        const width = bitmap.width;
        const height = width;
        const lowerLeftPos = (height - 1) * width * 4;
        for (let x = 0; x < width; x++) {
            for (let y = 0; y < height; y++) {
                const pxColor = img.getPixelColor(x, y);
                const r = pxColor >> 24 & 255;
                const g = pxColor >> 16 & 255;
                const b = pxColor >> 8 & 255;
                const a = pxColor & 255;
                const bmpPos = lowerLeftPos - y * width * 4 + x * 4;
                buf.writeUInt8(b, bmpPos);
                buf.writeUInt8(g, bmpPos + 1);
                buf.writeUInt8(r, bmpPos + 2);
                buf.writeUInt8(a, bmpPos + 3);
            }
        }
        return buf;
    }
}
exports.ICO = ICO;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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R0FBRyxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUVwRCxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDMUIsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUM5QixHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNsQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDZixDQUFDO0NBQ0o7QUF0TEQsa0JBc0xDIiwiZmlsZSI6Imljby5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSUNPIGNsYXNzIGZvciBtYW5pcHVsYXRpbmcgSUNPIGltYWdlcy5cbiAqL1xuaW1wb3J0ICogYXMgSmltcCBmcm9tIFwiamltcFwiO1xuaW1wb3J0IHsgUGFyYW1ldGVyVmFsaWRhdGlvbiB9IGZyb20gXCJ1bml0ZWpzLWZyYW1ld29yay9kaXN0L2hlbHBlcnMvcGFyYW1ldGVyVmFsaWRhdGlvblwiO1xuaW1wb3J0IHsgSUZpbGVTeXN0ZW0gfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9pbnRlcmZhY2VzL0lGaWxlU3lzdGVtXCI7XG5pbXBvcnQgeyBJTG9nZ2VyIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvaW50ZXJmYWNlcy9JTG9nZ2VyXCI7XG5pbXBvcnQgeyBEZWZhdWx0TG9nZ2VyIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvbG9nZ2Vycy9kZWZhdWx0TG9nZ2VyXCI7XG5cbmV4cG9ydCBjbGFzcyBJQ08ge1xuICAgIHB1YmxpYyBhc3luYyBmcm9tUG5ncyhsb2dnZXI6IElMb2dnZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVTeXN0ZW06IElGaWxlU3lzdGVtLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VGb2xkZXI6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZUZpbGVzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCB8IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RGb2xkZXI6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RGaWxlOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsKTogUHJvbWlzZTxudW1iZXI+IHtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGxvZ2dlciA9PT0gdW5kZWZpbmVkIHx8IGxvZ2dlciA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIERlZmF1bHRMb2dnZXIubG9nKFwiVW5hYmxlIHRvIGNvbnRpbnVlIHdpdGhvdXQgbG9nZ2VyXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZmlsZVN5c3RlbSA9PT0gdW5kZWZpbmVkIHx8IGZpbGVTeXN0ZW0gPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJVbmFibGUgdG8gY29udGludWUgd2l0aG91dCBmaWxlIHN5c3RlbVwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFQYXJhbWV0ZXJWYWxpZGF0aW9uLm5vdEVtcHR5KGxvZ2dlciwgXCJzb3VyY2VGb2xkZXJcIiwgc291cmNlRm9sZGVyKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIVBhcmFtZXRlclZhbGlkYXRpb24ubm90RW1wdHkobG9nZ2VyLCBcInNvdXJjZUZpbGVzXCIsIHNvdXJjZUZpbGVzKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIVBhcmFtZXRlclZhbGlkYXRpb24ubm90RW1wdHkobG9nZ2VyLCBcImRlc3RGb2xkZXJcIiwgZGVzdEZvbGRlcikpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFQYXJhbWV0ZXJWYWxpZGF0aW9uLm5vdEVtcHR5KGxvZ2dlciwgXCJkZXN0RmlsZVwiLCBkZXN0RmlsZSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgaW1hZ2VEYXRhOiBKaW1wW10gPSBbXTtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc291cmNlRmlsZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxlRXhpc3RzID0gYXdhaXQgZmlsZVN5c3RlbS5maWxlRXhpc3RzKHNvdXJjZUZvbGRlciwgc291cmNlRmlsZXNbaV0pO1xuICAgICAgICAgICAgICAgIGlmIChmaWxlRXhpc3RzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBuZ0J1ZmZlciA9IGF3YWl0IGZpbGVTeXN0ZW0uZmlsZVJlYWRCaW5hcnkoc291cmNlRm9sZGVyLCBzb3VyY2VGaWxlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwbmdCdWZmZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaiA9IGF3YWl0IEppbXAucmVhZChuZXcgQnVmZmVyKHBuZ0J1ZmZlcikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VEYXRhLnB1c2goaik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJTb3VyY2UgSW1hZ2UgaXMgemVybyBsZW5ndGhcIiwgdW5kZWZpbmVkLCBbIHNvdXJjZUZpbGVzW2ldIF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJTb3VyY2UgSW1hZ2UgZG9lcyBub3QgZXhpc3RcIiwgdW5kZWZpbmVkLCBbIHNvdXJjZUZpbGVzW2ldIF0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGRpckV4aXN0cyA9IGF3YWl0IGZpbGVTeXN0ZW0uZGlyZWN0b3J5RXhpc3RzKGRlc3RGb2xkZXIpO1xuICAgICAgICAgICAgaWYgKCFkaXJFeGlzdHMpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBmaWxlU3lzdGVtLmRpcmVjdG9yeUNyZWF0ZShkZXN0Rm9sZGVyKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgaWNvRGF0YSA9IHRoaXMuaW1hZ2VzVG9JY28oaW1hZ2VEYXRhKTtcblxuICAgICAgICAgICAgYXdhaXQgZmlsZVN5c3RlbS5maWxlV3JpdGVCaW5hcnkoZGVzdEZvbGRlciwgZGVzdEZpbGUsIGljb0RhdGEpO1xuXG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiQ29udmVyc2lvbiBmYWlsZWRcIiwgZSk7XG4gICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaW1hZ2VzVG9JY28oaW1hZ2VzOiBKaW1wW10pOiBCdWZmZXIge1xuICAgICAgICBjb25zdCBoZWFkZXIgPSB0aGlzLmdldEhlYWRlcihpbWFnZXMubGVuZ3RoKTtcbiAgICAgICAgY29uc3QgaGVhZGVyQW5kSWNvbkRpciA9IFtoZWFkZXJdO1xuICAgICAgICBjb25zdCBpbWFnZURhdGFBcnI6IEJ1ZmZlcltdID0gW107XG5cbiAgICAgICAgbGV0IGxlbiA9IGhlYWRlci5sZW5ndGg7XG4gICAgICAgIGxldCBvZmZzZXQgPSBoZWFkZXIubGVuZ3RoICsgKGltYWdlcy5sZW5ndGggKiAxNik7XG5cbiAgICAgICAgaW1hZ2VzLmZvckVhY2goaW1nID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRpciA9IHRoaXMuZ2V0RGlyKGltZywgb2Zmc2V0KTtcbiAgICAgICAgICAgIGNvbnN0IGJtcEluZm9IZWFkZXIgPSB0aGlzLmdldEJtcEluZm9IZWFkZXIoaW1nKTtcbiAgICAgICAgICAgIGNvbnN0IGRpYiA9IHRoaXMuZ2V0RGliKGltZyk7XG5cbiAgICAgICAgICAgIGhlYWRlckFuZEljb25EaXIucHVzaChkaXIpO1xuICAgICAgICAgICAgaW1hZ2VEYXRhQXJyLnB1c2goYm1wSW5mb0hlYWRlciwgZGliKTtcblxuICAgICAgICAgICAgbGVuICs9IGRpci5sZW5ndGggKyBibXBJbmZvSGVhZGVyLmxlbmd0aCArIGRpYi5sZW5ndGg7XG4gICAgICAgICAgICBvZmZzZXQgKz0gYm1wSW5mb0hlYWRlci5sZW5ndGggKyBkaWIubGVuZ3RoO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gQnVmZmVyLmNvbmNhdChoZWFkZXJBbmRJY29uRGlyLmNvbmNhdChpbWFnZURhdGFBcnIpLCBsZW4pO1xuICAgIH1cblxuICAgIC8vIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0lDT18oZmlsZV9mb3JtYXQpXG4gICAgcHJpdmF0ZSBnZXRIZWFkZXIobnVtT2ZJbWFnZXM6IG51bWJlcik6IEJ1ZmZlciB7XG4gICAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5hbGxvYyg2KTtcblxuICAgICAgICBidWYud3JpdGVVSW50MTZMRSgwLCAwKTsgLy8gUmVzZXJ2ZWQuIE11c3QgYWx3YXlzIGJlIDAuXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQxNkxFKDEsIDIpOyAvLyBTcGVjaWZpZXMgaW1hZ2UgdHlwZTogMSBmb3IgaWNvbiAoLklDTykgaW1hZ2VcbiAgICAgICAgYnVmLndyaXRlVUludDE2TEUobnVtT2ZJbWFnZXMsIDQpOyAvLyBTcGVjaWZpZXMgbnVtYmVyIG9mIGltYWdlcyBpbiB0aGUgZmlsZS5cblxuICAgICAgICByZXR1cm4gYnVmO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RGlyKGltZzogSmltcCwgb2Zmc2V0OiBudW1iZXIpOiBCdWZmZXIge1xuICAgICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2MoMTYpO1xuICAgICAgICBjb25zdCBiaXRtYXAgPSBpbWcuYml0bWFwO1xuICAgICAgICBjb25zdCBzaXplID0gYml0bWFwLmRhdGEubGVuZ3RoICsgNDA7XG4gICAgICAgIGNvbnN0IHdpZHRoID0gYml0bWFwLndpZHRoID49IDI1NiA/IDAgOiBiaXRtYXAud2lkdGg7XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHdpZHRoO1xuICAgICAgICBjb25zdCBicHAgPSAzMjtcblxuICAgICAgICBidWYud3JpdGVVSW50OCh3aWR0aCwgMCk7IC8vIFNwZWNpZmllcyBpbWFnZSB3aWR0aCBpbiBwaXhlbHMuXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQ4KGhlaWdodCwgMSk7IC8vIFNwZWNpZmllcyBpbWFnZSBoZWlnaHQgaW4gcGl4ZWxzLlxuICAgICAgICBidWYud3JpdGVVSW50OCgwLCAyKTsgLy8gU2hvdWxkIGJlIDAgaWYgdGhlIGltYWdlIGRvZXMgbm90IHVzZSBhIGNvbG9yIHBhbGV0dGUuXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQ4KDAsIDMpOyAvLyBSZXNlcnZlZC4gU2hvdWxkIGJlIDAuXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQxNkxFKDAsIDQpOyAvLyBTcGVjaWZpZXMgY29sb3IgcGxhbmVzLiBTaG91bGQgYmUgMCBvciAxLlxuICAgICAgICBidWYud3JpdGVVSW50MTZMRShicHAsIDYpOyAvLyBTcGVjaWZpZXMgYml0cyBwZXIgcGl4ZWwuXG4gICAgICAgIGJ1Zi53cml0ZVVJbnQzMkxFKHNpemUsIDgpOyAvLyBTcGVjaWZpZXMgdGhlIHNpemUgb2YgdGhlIGltYWdlJ3MgZGF0YSBpbiBieXRlc1xuICAgICAgICBidWYud3JpdGVVSW50MzJMRShvZmZzZXQsIDEyKTsgLy8gU3BlY2lmaWVzIHRoZSBvZmZzZXQgb2YgQk1QIG9yIFBORyBkYXRhIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgSUNPL0NVUiBmaWxlXG5cbiAgICAgICAgcmV0dXJuIGJ1ZjtcbiAgICB9XG5cbiAgICAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9CTVBfZmlsZV9mb3JtYXRcbiAgICBwcml2YXRlIGdldEJtcEluZm9IZWFkZXIoaW1nOiBKaW1wKTogQnVmZmVyIHtcbiAgICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmFsbG9jKDQwKTtcbiAgICAgICAgY29uc3QgYml0bWFwID0gaW1nLmJpdG1hcDtcbiAgICAgICAgY29uc3Qgc2l6ZSA9IGJpdG1hcC5kYXRhLmxlbmd0aDtcbiAgICAgICAgY29uc3Qgd2lkdGggPSBiaXRtYXAud2lkdGg7XG4gICAgICAgIC8vIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0lDT18oZmlsZV9mb3JtYXQpXG4gICAgICAgIC8vIC4uLkV2ZW4gaWYgdGhlIEFORCBtYXNrIGlzIG5vdCBzdXBwbGllZCxcbiAgICAgICAgLy8gaWYgdGhlIGltYWdlIGlzIGluIFdpbmRvd3MgQk1QIGZvcm1hdCxcbiAgICAgICAgLy8gdGhlIEJNUCBoZWFkZXIgbXVzdCBzdGlsbCBzcGVjaWZ5IGEgZG91YmxlZCBoZWlnaHQuXG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHdpZHRoICogMjtcbiAgICAgICAgY29uc3QgYnBwID0gMzI7XG5cbiAgICAgICAgYnVmLndyaXRlVUludDMyTEUoNDAsIDApOyAvLyBUaGUgc2l6ZSBvZiB0aGlzIGhlYWRlciAoNDAgYnl0ZXMpXG4gICAgICAgIGJ1Zi53cml0ZUludDMyTEUod2lkdGgsIDQpOyAvLyBUaGUgYml0bWFwIHdpZHRoIGluIHBpeGVscyAoc2lnbmVkIGludGVnZXIpXG4gICAgICAgIGJ1Zi53cml0ZUludDMyTEUoaGVpZ2h0LCA4KTsgLy8gVGhlIGJpdG1hcCBoZWlnaHQgaW4gcGl4ZWxzIChzaWduZWQgaW50ZWdlcilcbiAgICAgICAgYnVmLndyaXRlVUludDE2TEUoMSwgMTIpOyAvLyBUaGUgbnVtYmVyIG9mIGNvbG9yIHBsYW5lcyAobXVzdCBiZSAxKVxuICAgICAgICBidWYud3JpdGVVSW50MTZMRShicHAsIDE0KTsgLy8gVGhlIG51bWJlciBvZiBiaXRzIHBlciBwaXhlbFxuICAgICAgICBidWYud3JpdGVVSW50MzJMRSgwLCAxNik7IC8vIFRoZSBjb21wcmVzc2lvbiBtZXRob2QgYmVpbmcgdXNlZC5cbiAgICAgICAgYnVmLndyaXRlVUludDMyTEUoc2l6ZSwgMjApOyAvLyBUaGUgaW1hZ2Ugc2l6ZS5cbiAgICAgICAgYnVmLndyaXRlSW50MzJMRSgwLCAyNCk7IC8vIFRoZSBob3Jpem9udGFsIHJlc29sdXRpb24gb2YgdGhlIGltYWdlLiAoc2lnbmVkIGludGVnZXIpXG4gICAgICAgIGJ1Zi53cml0ZUludDMyTEUoMCwgMjgpOyAvLyBUaGUgaG9yaXpvbnRhbCByZXNvbHV0aW9uIG9mIHRoZSBpbWFnZS4gKHNpZ25lZCBpbnRlZ2VyKVxuICAgICAgICBidWYud3JpdGVVSW50MzJMRSgwLCAzMik7IC8vIFRoZSBudW1iZXIgb2YgY29sb3JzIGluIHRoZSBjb2xvciBwYWxldHRlLCBvciAwIHRvIGRlZmF1bHQgdG8gMm5cbiAgICAgICAgYnVmLndyaXRlVUludDMyTEUoMCwgMzYpOyAvLyBcdFRoZSBudW1iZXIgb2YgaW1wb3J0YW50IGNvbG9ycyB1c2VkLCBvciAwIHdoZW4gZXZlcnkgY29sb3IgaXMgaW1wb3J0YW50OyBnZW5lcmFsbHkgaWdub3JlZC5cblxuICAgICAgICByZXR1cm4gYnVmO1xuICAgIH1cblxuICAgIC8vIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0JNUF9maWxlX2Zvcm1hdFxuICAgIC8vIE5vdGUgdGhhdCB0aGUgYml0bWFwIGRhdGEgc3RhcnRzIHdpdGggdGhlIGxvd2VyIGxlZnQgaGFuZCBjb3JuZXIgb2YgdGhlIGltYWdlLlxuICAgIC8vIGJsdWUgZ3JlZW4gcmVkIGFscGhhIGluIG9yZGVyXG4gICAgcHJpdmF0ZSBnZXREaWIoaW1nOiBKaW1wKTogQnVmZmVyIHtcbiAgICAgICAgY29uc3QgYml0bWFwID0gaW1nLmJpdG1hcDtcbiAgICAgICAgY29uc3Qgc2l6ZSA9IGJpdG1hcC5kYXRhLmxlbmd0aDtcbiAgICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmFsbG9jKHNpemUpO1xuICAgICAgICBjb25zdCB3aWR0aCA9IGJpdG1hcC53aWR0aDtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gd2lkdGg7XG4gICAgICAgIGNvbnN0IGxvd2VyTGVmdFBvcyA9IChoZWlnaHQgLSAxKSAqIHdpZHRoICogNDtcblxuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHdpZHRoOyB4KyspIHtcbiAgICAgICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgaGVpZ2h0OyB5KyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBweENvbG9yID0gaW1nLmdldFBpeGVsQ29sb3IoeCwgeSk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCByID0gcHhDb2xvciA+PiAyNCAmIDI1NTtcbiAgICAgICAgICAgICAgICBjb25zdCBnID0gcHhDb2xvciA+PiAxNiAmIDI1NTtcbiAgICAgICAgICAgICAgICBjb25zdCBiID0gcHhDb2xvciA+PiA4ICYgMjU1O1xuICAgICAgICAgICAgICAgIGNvbnN0IGEgPSBweENvbG9yICYgMjU1O1xuXG4gICAgICAgICAgICAgICAgY29uc3QgYm1wUG9zID0gbG93ZXJMZWZ0UG9zIC0geSAqIHdpZHRoICogNCArIHggKiA0O1xuXG4gICAgICAgICAgICAgICAgYnVmLndyaXRlVUludDgoYiwgYm1wUG9zKTtcbiAgICAgICAgICAgICAgICBidWYud3JpdGVVSW50OChnLCBibXBQb3MgKyAxKTtcbiAgICAgICAgICAgICAgICBidWYud3JpdGVVSW50OChyLCBibXBQb3MgKyAyKTtcbiAgICAgICAgICAgICAgICBidWYud3JpdGVVSW50OChhLCBibXBQb3MgKyAzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBidWY7XG4gICAgfVxufVxuIl19
