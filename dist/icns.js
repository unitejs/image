"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * ICNS class for manipulating apple icns images.
 */
const Jimp = require("jimp");
const parameterValidation_1 = require("unitejs-framework/dist/helpers/parameterValidation");
class ICNS {
    fromPng(logger, fileSystem, sourceFolder, sourceFile, destFolder, destFile) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "sourceFolder", sourceFolder)) {
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "sourceFile", sourceFile)) {
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "destFolder", destFolder)) {
                    return 1;
                }
                if (!parameterValidation_1.ParameterValidation.notEmpty(logger, "destFile", destFile)) {
                    return 1;
                }
                const sourceImage = fileSystem.pathCombine(sourceFolder, sourceFile);
                logger.info("Reading Source PNG", [sourceImage]);
                const pngImageData = yield Jimp.read(sourceImage);
                const icnsData = yield this.imageToIcns(logger, pngImageData);
                logger.info("Writing ICNS ", [fileSystem.pathCombine(destFolder, destFile)]);
                yield fileSystem.fileWriteBinary(destFolder, destFile, icnsData);
                return 0;
            }
            catch (e) {
                logger.error("Conversion failed", e);
                return 1;
            }
        });
    }
    imageToIcns(logger, sourceImage) {
        return __awaiter(this, void 0, void 0, function* () {
            // https://en.wikipedia.org/wiki/Apple_Icon_Image_format
            // We only support the new image formats the use embedded png
            const icnsImages = [
                { type: "icp4", size: 16, info: "16" },
                { type: "icp5", size: 32, info: "32x32" },
                { type: "icp6", size: 64, info: "64x64" },
                { type: "ic07", size: 128, info: "128x128" },
                { type: "ic08", size: 256, info: "256x256" },
                { type: "ic09", size: 512, info: "512x512" },
                { type: "ic10", size: 1024, info: "512x512@2" },
                { type: "ic11", size: 32, info: "16x16@2" },
                { type: "ic12", size: 64, info: "32x32@2" },
                { type: "ic13", size: 256, info: "128x128@2" },
                { type: "ic14", size: 512, info: "256x256@2" }
            ];
            let outBuffer = Buffer.alloc(8, 0);
            outBuffer.write("icns", 0);
            for (let i = 0; i < icnsImages.length; i++) {
                logger.info("Creating Sub Image", [icnsImages[i].info]);
                outBuffer = yield this.appendChunk(sourceImage, outBuffer, icnsImages[i].type, icnsImages[i].size);
            }
            // Write total file size at offset 4 of output
            outBuffer.writeUInt32BE(outBuffer.length, 4);
            return outBuffer;
        });
    }
    appendChunk(sourceImage, outBuffer, type, size) {
        return __awaiter(this, void 0, void 0, function* () {
            return new Promise((resolve, reject) => {
                const chunkImage = sourceImage.clone();
                chunkImage.resize(size, size);
                chunkImage.getBuffer(Jimp.MIME_PNG, (err, pngData) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        // Icon header, 'type' + (length of icon + icon header length)
                        const iconHeader = Buffer.alloc(8, 0);
                        iconHeader.write(type, 0);
                        iconHeader.writeUInt32BE(pngData.length + 8, 4);
                        resolve(Buffer.concat([outBuffer, iconHeader, pngData], outBuffer.length + iconHeader.length + pngData.length));
                    }
                });
            });
        });
    }
}
exports.ICNS = ICNS;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RCxvQkE0RkMiLCJmaWxlIjoiaWNucy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSUNOUyBjbGFzcyBmb3IgbWFuaXB1bGF0aW5nIGFwcGxlIGljbnMgaW1hZ2VzLlxuICovXG5pbXBvcnQgKiBhcyBKaW1wIGZyb20gXCJqaW1wXCI7XG5pbXBvcnQgeyBQYXJhbWV0ZXJWYWxpZGF0aW9uIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvaGVscGVycy9wYXJhbWV0ZXJWYWxpZGF0aW9uXCI7XG5pbXBvcnQgeyBJRmlsZVN5c3RlbSB9IGZyb20gXCJ1bml0ZWpzLWZyYW1ld29yay9kaXN0L2ludGVyZmFjZXMvSUZpbGVTeXN0ZW1cIjtcbmltcG9ydCB7IElMb2dnZXIgfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9pbnRlcmZhY2VzL0lMb2dnZXJcIjtcblxuZXhwb3J0IGNsYXNzIElDTlMge1xuICAgIHB1YmxpYyBhc3luYyBmcm9tUG5nKGxvZ2dlcjogSUxvZ2dlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlU3lzdGVtOiBJRmlsZVN5c3RlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VGb2xkZXI6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlRmlsZTogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0Rm9sZGVyOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RGaWxlOiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoIVBhcmFtZXRlclZhbGlkYXRpb24ubm90RW1wdHkobG9nZ2VyLCBcInNvdXJjZUZvbGRlclwiLCBzb3VyY2VGb2xkZXIpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghUGFyYW1ldGVyVmFsaWRhdGlvbi5ub3RFbXB0eShsb2dnZXIsIFwic291cmNlRmlsZVwiLCBzb3VyY2VGaWxlKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIVBhcmFtZXRlclZhbGlkYXRpb24ubm90RW1wdHkobG9nZ2VyLCBcImRlc3RGb2xkZXJcIiwgZGVzdEZvbGRlcikpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFQYXJhbWV0ZXJWYWxpZGF0aW9uLm5vdEVtcHR5KGxvZ2dlciwgXCJkZXN0RmlsZVwiLCBkZXN0RmlsZSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3Qgc291cmNlSW1hZ2UgPSBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHNvdXJjZUZvbGRlciwgc291cmNlRmlsZSk7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhcIlJlYWRpbmcgU291cmNlIFBOR1wiLCBbc291cmNlSW1hZ2VdKTtcbiAgICAgICAgICAgIGNvbnN0IHBuZ0ltYWdlRGF0YTogSmltcCA9IGF3YWl0IEppbXAucmVhZChzb3VyY2VJbWFnZSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGljbnNEYXRhID0gYXdhaXQgdGhpcy5pbWFnZVRvSWNucyhsb2dnZXIsIHBuZ0ltYWdlRGF0YSk7XG5cbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKFwiV3JpdGluZyBJQ05TIFwiLCBbIGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUoZGVzdEZvbGRlciwgZGVzdEZpbGUpIF0pO1xuICAgICAgICAgICAgYXdhaXQgZmlsZVN5c3RlbS5maWxlV3JpdGVCaW5hcnkoZGVzdEZvbGRlciwgZGVzdEZpbGUsIGljbnNEYXRhKTtcblxuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcIkNvbnZlcnNpb24gZmFpbGVkXCIsIGUpO1xuICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGltYWdlVG9JY25zKGxvZ2dlcjogSUxvZ2dlciwgc291cmNlSW1hZ2U6IEppbXApOiBQcm9taXNlPEJ1ZmZlcj4ge1xuICAgICAgICAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9BcHBsZV9JY29uX0ltYWdlX2Zvcm1hdFxuICAgICAgICAvLyBXZSBvbmx5IHN1cHBvcnQgdGhlIG5ldyBpbWFnZSBmb3JtYXRzIHRoZSB1c2UgZW1iZWRkZWQgcG5nXG4gICAgICAgIGNvbnN0IGljbnNJbWFnZXMgPSBbXG4gICAgICAgICAgICB7IHR5cGU6IFwiaWNwNFwiLCBzaXplOiAxNiwgaW5mbzogXCIxNlwiIH0sXG4gICAgICAgICAgICB7IHR5cGU6IFwiaWNwNVwiLCBzaXplOiAzMiwgaW5mbzogXCIzMngzMlwiIH0sXG4gICAgICAgICAgICB7IHR5cGU6IFwiaWNwNlwiLCBzaXplOiA2NCwgaW5mbzogXCI2NHg2NFwiIH0sXG4gICAgICAgICAgICB7IHR5cGU6IFwiaWMwN1wiLCBzaXplOiAxMjgsIGluZm86IFwiMTI4eDEyOFwiIH0sXG4gICAgICAgICAgICB7IHR5cGU6IFwiaWMwOFwiLCBzaXplOiAyNTYsIGluZm86IFwiMjU2eDI1NlwiIH0sXG4gICAgICAgICAgICB7IHR5cGU6IFwiaWMwOVwiLCBzaXplOiA1MTIsIGluZm86IFwiNTEyeDUxMlwiIH0sXG4gICAgICAgICAgICB7IHR5cGU6IFwiaWMxMFwiLCBzaXplOiAxMDI0LCBpbmZvOiBcIjUxMng1MTJAMlwiIH0sXG4gICAgICAgICAgICB7IHR5cGU6IFwiaWMxMVwiLCBzaXplOiAzMiwgaW5mbzogXCIxNngxNkAyXCIgfSxcbiAgICAgICAgICAgIHsgdHlwZTogXCJpYzEyXCIsIHNpemU6IDY0LCBpbmZvOiBcIjMyeDMyQDJcIiB9LFxuICAgICAgICAgICAgeyB0eXBlOiBcImljMTNcIiwgc2l6ZTogMjU2LCBpbmZvOiBcIjEyOHgxMjhAMlwiIH0sXG4gICAgICAgICAgICB7IHR5cGU6IFwiaWMxNFwiLCBzaXplOiA1MTIsIGluZm86IFwiMjU2eDI1NkAyXCIgfVxuICAgICAgICBdO1xuXG4gICAgICAgIGxldCBvdXRCdWZmZXIgPSBCdWZmZXIuYWxsb2MoOCwgMCk7XG4gICAgICAgIG91dEJ1ZmZlci53cml0ZShcImljbnNcIiwgMCk7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpY25zSW1hZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhcIkNyZWF0aW5nIFN1YiBJbWFnZVwiLCBbaWNuc0ltYWdlc1tpXS5pbmZvXSk7XG5cbiAgICAgICAgICAgIG91dEJ1ZmZlciA9IGF3YWl0IHRoaXMuYXBwZW5kQ2h1bmsoc291cmNlSW1hZ2UsIG91dEJ1ZmZlciwgaWNuc0ltYWdlc1tpXS50eXBlLCBpY25zSW1hZ2VzW2ldLnNpemUpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gV3JpdGUgdG90YWwgZmlsZSBzaXplIGF0IG9mZnNldCA0IG9mIG91dHB1dFxuICAgICAgICBvdXRCdWZmZXIud3JpdGVVSW50MzJCRShvdXRCdWZmZXIubGVuZ3RoLCA0KTtcblxuICAgICAgICByZXR1cm4gb3V0QnVmZmVyO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgYXBwZW5kQ2h1bmsoc291cmNlSW1hZ2U6IEppbXAsIG91dEJ1ZmZlcjogQnVmZmVyLCB0eXBlOiBzdHJpbmcsIHNpemU6IG51bWJlcik6IFByb21pc2U8QnVmZmVyPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxCdWZmZXI+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNodW5rSW1hZ2UgPSBzb3VyY2VJbWFnZS5jbG9uZSgpO1xuICAgICAgICAgICAgY2h1bmtJbWFnZS5yZXNpemUoc2l6ZSwgc2l6ZSk7XG5cbiAgICAgICAgICAgIGNodW5rSW1hZ2UuZ2V0QnVmZmVyKEppbXAuTUlNRV9QTkcsIChlcnIsIHBuZ0RhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEljb24gaGVhZGVyLCAndHlwZScgKyAobGVuZ3RoIG9mIGljb24gKyBpY29uIGhlYWRlciBsZW5ndGgpXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGljb25IZWFkZXI6IEJ1ZmZlciA9IEJ1ZmZlci5hbGxvYyg4LCAwKTtcbiAgICAgICAgICAgICAgICAgICAgaWNvbkhlYWRlci53cml0ZSh0eXBlLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgaWNvbkhlYWRlci53cml0ZVVJbnQzMkJFKHBuZ0RhdGEubGVuZ3RoICsgOCwgNCk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShCdWZmZXIuY29uY2F0KFtvdXRCdWZmZXIsIGljb25IZWFkZXIsIHBuZ0RhdGFdLCBvdXRCdWZmZXIubGVuZ3RoICsgaWNvbkhlYWRlci5sZW5ndGggKyBwbmdEYXRhLmxlbmd0aCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=
